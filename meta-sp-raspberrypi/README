This document describes "howto use meta-sp-raspberrypi"

==== Build for raspberrypi 2
# make new directory for target. Shorter name length is preferred.
# ex) /opt/R2
mkdir R2
cd R2

# from
git clone git://git.yoctoproject.org/poky.git
cd poky
git clone git://git.yoctoproject.org/meta-raspberrypi

git clone https://github.com/flihp/meta-measured.git
git clone https://github.com/SecurityPlatformCoKr/meta-sp

cd ..
source poky/oe-init-build-env

(now you are in R2/build)
# edit variables in conf/local.conf

    MACHINE ??= "raspberrypi2"
    GPU_MEM = "16"
    PACKAGE_CLASSES ?= "package_ipk"
    DISTRO ?= "poky-raspberrypi2"
    KERNEL_IMAGETYPE="uImage"
    KERNEL_DEVICETREE += "bcm2709-rpi-2-b-tpm-infineon.dtb bcm2709-rpi-2-b-tpm-atmel.dtb"
    SDIMG_ROOTFS_TYPE = "ext4"

#edit conf/bblayers.conf

BBLAYERS ?= " \
  /opt/R2/poky/meta \
  /opt/R2/poky/meta-yocto \
  /opt/R2/poky/meta-yocto-bsp \
  /opt/R2/poky/meta-raspberrypi \
  /opt/R2/poky/meta-measured \
  /opt/R2/poky/meta-sp/meta-sp \
  /opt/R2/poky/meta-sp/meta-sp-raspberrypi \
  "

BBMASK = "meta-sp/meta-sp/recipes-connectivity/openssh/openssh_6.5p1.bbappend"
BBMASK .= "|meta-sp/meta-sp/recipes-core/busybox/busybox_1.22.1.bbappend"
BBMASK .= "|meta-raspberrypi/recipes-bsp/u-boot/u-boot-rpi_git.bb"


#build image
bitbake sp-rpi-image

after the command done, you can use "tmp/deploy/images/raspberrypi2/sp-rpi-image-raspberrypi2.rpi-sdimg" as SD image.

# run 'dd' to write the image into SD card.
# you might change sdX to mmcblkX, according to your PC's setting.
dd if=tmp/deploy/images/raspberrypi2/sp-rpi-image-raspberrypi2.rpi-sdimg | pv -s 192937984 | sudo dd of=/dev/sdX bs=16M

==== Using U-boot

* verified boot
set:
    KERNEL_IMAGETYPE="uImage"
    KERNEL_DEVICETREE += "bcm2709-rpi-2-b-tpm-infineon.dtb bcm2709-rpi-2-b-tpm-atmel.dtb"

boot sequence:
RPI's loader -> kernel7.img(u-boot) -> uImage (FIT format image with signing).

==== Initializing tpm

* single-user mode boot
 * edit /boot/extlinux/extlinux.conf and add "default FIT.single"
* clear tpm with tpm_clear
 * confirm that shunt exists - circuit is short
 * tpm_setpresense --enable-hw
 * tpm_setpresense --enable-cmd
 * tpm_setenable -ef
 * tpm-setactive -a
 * reboot
* take ownership of tpm
 * tpm_takeownership -yz
* set back default to FIT and reboot
